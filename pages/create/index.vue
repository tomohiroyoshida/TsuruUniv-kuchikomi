<template>
  <v-container id="create" class="pa-0">
    <v-row no-gutters justify="center">
      <v-col cols="12" lg="9">
        <div class="text-h6 d-flex justify-center my-5 font-weight-bold">
          „ÇØ„ÉÅ„Ç≥„Éü‰ΩúÊàê
        </div>
        <v-form ref="form" v-model="isFormValid">
          <v-row no-gutters justify="center">
            <!-- ÊéàÊ•≠Âêç -->
            <v-col cols="11">
              <TextCaption required>
                ÊéàÊ•≠Âêç (Ë¶ã„Å§„Åã„Çâ„Å™„ÅÑÂ†¥Âêà„ÅØ
                <nuxt-link to="/create/new-class"
                  >„Åì„Å°„Çâ„Åã„ÇâÊéàÊ•≠„Çí‰ΩúÊàê</nuxt-link
                >)
              </TextCaption>
              <v-autocomplete
                v-model="selectedClassId"
                :items="autoCompleteClasses"
                :rules="RULES.required"
                flat
                solo
                dense
                outlined
                clearable
                cache-items
                hide-no-data
                item-color="primary"
                color="primary"
                label="ÊéàÊ•≠Âêç„ÇíÂÖ•Âäõ ÈÅ∏Êäû"
                persistent-hint
              />
            </v-col>
          </v-row>

          <!--  ÊéàÊ•≠„ÅÆÊÉÖÂ†±„ÅÆÊõ∏„Åã„Çå„Åü„Ç´„Éº„Éâ -->
          <v-row v-show="selectedClassId" no-gutters justify="center">
            <v-col cols="11">
              <TextCaption title="ÊéàÊ•≠„ÅÆÊÉÖÂ†±" />
              <v-card rounded outlined>
                <v-card-title>{{ classCardInfo.classTitle }}</v-card-title>
                <v-card-subtitle>
                  Ë¨õÂ∏´: {{ classCardInfo.teacherName }}
                </v-card-subtitle>
              </v-card>
            </v-col>
          </v-row>

          <!-- ÂèóË¨õ„Åó„ÅüÂπ¥ -->
          <v-row no-gutters justify="center">
            <v-col cols="11">
              <TextCaption required title="ÂèóË¨õ„Åó„ÅüÂπ¥" />
              <SelectInput
                v-model="classYear"
                :items="years"
                :rules="RULES.required"
              />
            </v-col>
          </v-row>
          <!-- „Åä„Åô„Åô„ÇÅÂ∫¶ -->
          <v-row no-gutters justify="center">
            <v-col cols="11">
              <TextCaption required title="„Åä„Åô„Åô„ÇÅÂ∫¶(0.5~5)" />
              <div class="my-2 d-flex justify-start">
                <v-rating
                  v-model="rating"
                  half-increments
                  color="star"
                  background-color="grey lighten-1"
                />
                <div class="ml-5 my-2">({{ rating }})</div>
              </div>
            </v-col>
          </v-row>
          <!-- „Çø„Ç§„Éà„É´ -->
          <v-row no-gutters justify="center">
            <v-col cols="11">
              <TextCaption required title="„ÇØ„ÉÅ„Ç≥„Éü„ÅÆ„Çø„Ç§„Éà„É´" />
              <TextInput
                v-model="kuchikomiTitle"
                :rules="RULES.requiredWith30"
                :counter="30"
                placeholder="‰æãÔºö „Åä„Åô„Åô„ÇÅ„ÅÆÊéàÊ•≠„Åß„Åô"
              />
            </v-col>
          </v-row>
          <!-- „ÇØ„ÉÅ„Ç≥„Éü -->
          <v-row no-gutters justify="center">
            <v-col cols="11">
              <TextCaption required title="„ÇØ„ÉÅ„Ç≥„Éü„ÅÆÂÜÖÂÆπ" />
              <TextareaInput
                v-model="kuchikomi"
                :rules="RULES.kuchikomi"
                placeholder="‰æãÔºö ÊéàÊ•≠„ÇÇÈù¢ÁôΩ„ÅÑ„ÅóÂÖàÁîü„ÇÇÂÑ™„Åó„ÅÑ„Åß„Åô„ÄÇ „Åü„Å†„ÉÜ„Çπ„Éà„ÅØÈõ£„Åó„ÅÑ„ÅÆ„ÅßË¶ÅÂØæÁ≠ñ„Åß„ÅôÔºÅ"
              />
            </v-col>
          </v-row>
        </v-form>

        <!-- ÈÄÅ‰ø°„Éª„Ç≠„É£„É≥„Çª„É´„Éú„Çø„É≥ -->
        <div class="d-flex justify-center py-3">
          <AppBtn
            color="grey darken-2"
            class="mr-1"
            :disabled="disabled"
            @click="isOpenResetConfirm = true"
          >
            „É™„Çª„ÉÉ„Éà
          </AppBtn>
          <AppBtn
            color="primary"
            depressed
            :disabled="!isFormValid || disabled"
            @click="openCreateConfirm"
          >
            ‰ΩúÊàê
          </AppBtn>
        </div>
      </v-col>

      <!-- Á¢∫Ë™ç„ÉÄ„Ç§„Ç¢„É≠„Ç∞ -->
      <KuchikomiConfirm
        v-model="isOpenCreateConfirm"
        :input="kuchikomiInput"
        type="createKuchikomi"
        @ok="createKuchikomi"
      />
      <ConfirmDialog
        v-model="isOpenResetConfirm"
        text="reset"
        @ok="resetInput"
      />

      <!-- „Çπ„Éä„ÉÉ„ÇØ„Éê„Éº -->
      <SnackBar
        v-model="isOpenSuccessSnackbar"
        text="„ÄêÊàêÂäü„Äë„ÇØ„ÉÅ„Ç≥„Éü„Çí‰ΩúÊàê„Åó„Åæ„Åó„Åü!„ÅîÂçîÂäõ„ÅÇ„Çä„Åå„Å®„ÅÜ„Åî„Åñ„ÅÑ„Åæ„Åôüòä"
        color="success"
      />
      <SnackBar
        v-model="isOpenErrorSnackbar"
        text="„Äê„Ç®„É©„Éº„Äë„Ç®„É©„Éº„ÅåËµ∑„Åç„Åæ„Åó„Åü„ÄÇÁîªÈù¢„Çí„É™„É≠„Éº„Éâ„Åó„Å¶„ÇÇ„ÅÜ‰∏ÄÂ∫¶Ë©¶„Åó„Å¶„Åè„Å†„Åï„ÅÑüò¢ Áõ¥„Çâ„Å™„ÅÑÂ†¥Âêà„ÅØÈÅãÂñ∂„Å´ÈÄ£Áµ°„Åó„Å¶„Åè„Å†„Åï„ÅÑüôá‚Äç‚ôÇÔ∏è"
        color="error"
      />
    </v-row>
  </v-container>
</template>

<script lang="ts" async>
import { defineComponent, ref, watch } from '@nuxtjs/composition-api'
import { Class } from '@/types/State'
import { db } from '@/plugins/firebase'
import { CollKuchikomi, User } from 'types/State'
import { KUCHIKOMI_TAGS } from '@/data/TAGS'
import { setAvgRating } from '@/helpers/setAvgRating'
import { getNewDate } from '@/helpers/getNewDate'
import { suid } from 'rand-token'

const RULES = {
  required: [(v: string) => !!v || '„Åì„ÅÆÊ¨Ñ„ÅÆÂÖ•Âäõ„ÅØÂøÖÈ†à„Åß„Åô'],
  kuchikomi: [
    (v: string) => !!v || '„Åì„ÅÆÊ¨Ñ„ÅÆÂÖ•Âäõ„ÅØÂøÖÈ†à„Åß„Åô',
    (v: string) =>
      (v && v.length <= 1000) || '„ÇØ„ÉÅ„Ç≥„ÉüÂÜÖÂÆπ„ÅØ1000ÊñáÂ≠ó‰ª•‰∏ã„ÅßË®òÂÖ•„Åó„Å¶„Åè„Å†„Åï„ÅÑ'
  ],
  requiredWith30: [
    (v: string) => !!v || '„Åì„ÅÆÊ¨Ñ„ÅÆÂÖ•Âäõ„ÅØÂøÖÈ†à„Åß„Åô',
    (v: string) => (v && v.length <= 30) || '30ÊñáÂ≠ó‰ª•‰∏ã„ÅßË®òÂÖ•„Åó„Å¶„Åè„Å†„Åï„ÅÑ'
  ]
} as const
interface CurrentClass {
  docId: string
  classTitle: string
  teacherName: string
  createdBy: string
  createdAt: string
}

export default defineComponent({
  name: 'create',
  setup(_, { root }) {
    const teacher = ref('')
    const isFormValid = ref(true)
    const selectedTags = ref([])
    const rating = ref(0.5)
    const kuchikomiTitle = ref('')
    const kuchikomi = ref('')
    const classYear = ref('')
    const years = ref(['2016', '2017', '2018', '2019', '2020', '2021', '‰∏çÊòé']) // TODO: daysjs„Å®„Åã‰Ωø„Å£„Å¶ÊúÄÊñ∞„ÅÆÂπ¥Êúà~10Âπ¥ÂâçÔºü„Åæ„ÅßÈÅ∏Êäû„Åß„Åç„Çã„Çà„ÅÜ„Å´
    const disabled = ref(false)

    // ÊéàÊ•≠ÊÉÖÂ†±„ÅÆ„Ç´„Éº„Éâ
    // Vuex Store„Å´„ÅÇ„Çã currentClass „ÅÆ„Éá„Éº„Çø
    const currentClass: CurrentClass = Object.assign(
      {},
      root.$store.getters.currentClass
    )
    const selectedClassId = ref(currentClass.docId || '')
    // ÈÅ∏Êäû„Åï„Çå„ÅüÊéàÊ•≠Âêç„ÇíÁõ£Ë¶ñ
    watch(selectedClassId, (classId: string) => {
      classList.value.find((item) =>
        item.docId === classId ? (classCardInfo.value = item) : ''
      )
    })

    const classCardInfo = ref({
      docId: currentClass.docId || selectedClassId.value,
      classTitle: currentClass.classTitle || '',
      teacherName: currentClass.teacherName || '',
      createdAt: currentClass.createdAt || '',
      createdBy: currentClass.createdBy || ''
    })

    // „ÇØ„ÉÅ„Ç≥„Éü‰ΩúÊàê
    const isOpenCreateConfirm = ref(false)
    const isOpenSuccessSnackbar = ref(false)
    const isOpenErrorSnackbar = ref(false)
    const kuchikomiInput = ref({})
    const openCreateConfirm = () => {
      kuchikomiInput.value = {
        classTitle: classCardInfo.value.classTitle,
        teacherName: classCardInfo.value.teacherName,
        classYear: classYear.value,
        rating: rating.value,
        kuchikomiTitle: kuchikomiTitle.value,
        kuchikomi: kuchikomi.value
      }
      isOpenCreateConfirm.value = true
      isOpenSuccessSnackbar.value = false
      isOpenErrorSnackbar.value = false
    }
    const createKuchikomi = async (): Promise<void> => {
      disabled.value = true
      if (csrfToken !== storedCsrfToken) {
        isOpenErrorSnackbar.value = true
        return
      }

      isOpenCreateConfirm.value = false
      // kuchikomis collection „Å´ËøΩÂä†
      try {
        const kuchikomiDocRef = db.collection('kuchikomis').doc()
        const storeUser = ref<User>(root.$store.getters.user)
        const collectionData: CollKuchikomi = {
          docId: kuchikomiDocRef.id,
          rating: rating.value,
          classYear: classYear.value,
          kuchikomiTitle: kuchikomiTitle.value,
          kuchikomi: kuchikomi.value,
          uid: storeUser.value.uid,
          username: storeUser.value.username,
          classId: classCardInfo.value.docId,
          classTitle: classCardInfo.value.classTitle,
          classTeacherName: classCardInfo.value.teacherName,
          createdAt: getNewDate()
        }
        await db
          .collection('kuchikomis')
          .doc(collectionData.docId)
          .set(collectionData)
        await setAvgRating(selectedClassId.value) // „Åä„Åô„Åô„ÇÅÂ∫¶„ÅÆÂπ≥ÂùáÂÄ§„ÇíÊõ¥Êñ∞
        resetInput()
        isOpenSuccessSnackbar.value = true
        emptyCurrentClass()
        disabled.value = false
      } catch (e) {
        console.error('create', e)
        isOpenErrorSnackbar.value = true
        disabled.value = false
      }
    }

    // „Ç≠„É£„É≥„Çª„É´
    const isOpenResetConfirm = ref(false)
    // Ë®òÂÖ•ÂÜÖÂÆπ„ÇíÂÖ®„Å¶„É™„Çª„ÉÉ„Éà
    const form = ref(null)
    const resetInput = () => {
      isOpenResetConfirm.value = false
      selectedClassId.value = ''
      classYear.value = ''
      rating.value = 0.5
      kuchikomiTitle.value = ''
      kuchikomi.value = ''
      // @ts-ignore "Object is possibly null" „Ç®„É©„Éº„Çíignore
      form.value.resetValidation()
    }
    // Store „ÅÆ currentClass „ÇíÁ©∫„Å´„Åô„Çã
    const emptyCurrentClass = () => {
      const emptyClass = {
        docId: '',
        classTitle: '',
        teacherName: '',
        createdBy: '',
        createdAt: ''
      }
      root.$store.dispatch('setCurrentClass', emptyClass)
    }

    /**
     * init
     */
    // ÊéàÊ•≠„ÅÆ„É™„Çπ„Éà
    const csrfToken = suid(16)
    root.$store.dispatch('setCsrfToken', csrfToken)
    const storedCsrfToken = root.$store.getters.csrfToken
    const classList = ref<Class[]>([])
    classList.value = root.$store.getters.classes

    // ÊéàÊ•≠„ÅÆ„Çø„Ç§„Éà„É´„ÅÆÈÖçÂàó„Çí‰ΩúÊàê
    interface AutocompleteClasses {
      text: string
      value: string
    }
    const autoCompleteClasses = ref<AutocompleteClasses[]>([])
    classList.value.forEach((item) => {
      autoCompleteClasses.value.push({
        text: `${item.classTitle} (${item.teacherName})`,
        value: item.docId
      })
    })

    return {
      RULES,
      KUCHIKOMI_TAGS,
      selectedTags,
      isFormValid,
      rating,
      kuchikomiTitle,
      kuchikomi,
      classYear,
      years,
      disabled,
      currentClass,
      classList,
      selectedClassId,
      autoCompleteClasses,
      teacher,
      isOpenSuccessSnackbar,
      isOpenErrorSnackbar,
      resetInput,
      emptyCurrentClass,
      kuchikomiInput,
      createKuchikomi,
      isOpenCreateConfirm,
      isOpenResetConfirm,
      form,
      classCardInfo,
      openCreateConfirm,
      csrfToken,
      storedCsrfToken
    }
  }
})
</script>

<style scoped>
#create {
  margin-top: 3rem;
}
</style>
